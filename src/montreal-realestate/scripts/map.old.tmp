mouse =
  x: 0
  y: 0
  scrollTop: 0

document.addEventListener "mousemove", (e) ->
  mouse.x = e.clientX or e.pageX
  mouse.y = e.clientY or e.pageY
, false
document.addEventListener "scroll", (e) ->
  mouse.scrollTop = document.body.scrollTop
, false

scaleExtent = 55000
rotation = [73.6, -45.6]
projection = d3.geo.transverseMercator()
  .scale scaleExtent
  .rotate rotation
path = d3.geo.path().projection(projection)

redraw = ->
  if d3.event
    scale = d3.event.scale
    t = d3.event.translate

    # if scaling changes, ignore translation (otherwise touch zooms are weird)
    projection.scale scale

    tp = projection.rotate()
    console.log tp, t

    # use x translation to rotate based on current scale
    projection.rotate [
      rotation[0] + t[0]/(scale / 100)
      rotation[1] - t[1]/(scale / 100)
    ]

  # re-project path data
  svg.selectAll("path").attr "d", path
  console.log 'ere'

zoom = d3.behavior.zoom()
  .scaleExtent([scaleExtent, 10*scaleExtent])
  .scale(projection.scale())
  .translate([0,0])
  .on("zoom", redraw)

svg = d3.select "#map"
  .call zoom
popover = d3.select "#popover"

d3.json "assets/montreal.topo.json", (error, mtl) ->

  colors = d3.scale.ordinal().domain(d3.range(0,2000)).range(colorbrewer.YlGn[9])
  svg.append "g"
    #.on "mouseover", (d) ->
      #popover
        #.style 'opacity', 100
    #.on "mouseout", (d) ->
      #popover
        #.style 'opacity', 0
    .selectAll "path"
    .data(topojson.feature(mtl, mtl.objects['montreal.data']).features)
    .enter()
    .append "path"
    .attr "class", "land"
    .attr "d", path
    .style "fill", (d)-> colors d.properties.data_points
    #.style "stroke", (d)-> colors d.properties.data_points
    #.on "mousemove", (d) ->
      #popover.style 'top', (mouse.y + mouse.scrollTop + 50 ) + 'px'
      #.style 'left', (mouse.x - 100) + 'px'
      #.select ".title"
      #.text d.properties.name
      #popover.select ".body"
        #.text d.properties.data_points
      ##console.log d.properties
      ##console.log d.properties.name, d.properties

